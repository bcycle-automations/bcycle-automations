name: MTEK Reminder Emails

on:
  schedule:
    # Run every hour
    - cron: "0 * * * *"
  workflow_dispatch: {}

# Needed so the workflow can commit the updated state JSON file
permissions:
  contents: write

jobs:
  send-reminders:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Needed so git can commit & push

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Run MTEK reminders script
        run: node scripts/send-mtek-reminders.js
        env:
          MTEK_API_TOKEN: ${{ secrets.MTEK_API_TOKEN }}
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_STUDIOS_TABLE: ${{ secrets.AIRTABLE_STUDIOS_TABLE }}
          TIMEZONE: "America/Toronto"

          # Microsoft Graph (send email)
          M365_TENANT_ID: ${{ secrets.M365_TENANT_ID }}
          M365_CLIENT_ID: ${{ secrets.M365_CLIENT_ID }}
          M365_CLIENT_SECRET: ${{ secrets.M365_CLIENT_SECRET }}
          M365_SENDER_UPN: ${{ secrets.M365_SENDER_UPN }}

          # Optional (safe defaults)
          FROM_NAME: "b.cycle"
          MAX_EMAILS_PER_MINUTE: "20"

      - name: Commit updated state file
        run: |
          # Check if the state file changed
          if git status --porcelain | grep "state/mtek-reminder-state.json"; then
            echo "State file changed. Committing..."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add state/mtek-reminder-state.json
            git commit -m "Update reminder state [skip ci]" || echo "Nothing to commit"
            git push
          else
            echo "No state changes to commit."
          fi
