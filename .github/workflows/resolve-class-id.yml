name: Resolve Class ID from MTEK

on:
  # Manual run from GitHub UI
  workflow_dispatch:
    inputs:
      record_id:
        description: "Optional Airtable record ID (recXXXX) to process only one record"
        required: false
        type: string

  # Daily run at 1:00 AM EST (06:00 UTC, non-DST)
  schedule:
    - cron: "0 6 * * *"

  # Triggered from Make via GitHub API
  repository_dispatch:
    types: [resolve_class_id]

permissions:
  contents: read

concurrency:
  group: resolve-class-id
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      # Airtable
      AIRTABLE_BASE_ID: applRovmu340OSBSg
      AIRTABLE_TABLE_NAME: All Classes
      AIRTABLE_VIEW_NAME: NO ID DO NOT TOUCH

      AIRTABLE_FIELD_ROOM: room
      AIRTABLE_FIELD_DATE_UTC: date
      AIRTABLE_FIELD_CLASS_ID: Class ID

      # MTEK
      MTEK_BASE_URL: https://bcycle.marianatek.com

      # Safety
      MAX_RECORDS: "500"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run resolver
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          MTEK_API_TOKEN: ${{ secrets.MTEK_API_TOKEN }}
          DISPATCH_RECORD_ID: ${{ inputs.record_id || github.event.client_payload.record_id }}
        run: node scripts/resolve-class-id.mjs
